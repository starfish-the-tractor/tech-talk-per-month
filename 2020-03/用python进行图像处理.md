# 用python进行图像处理

这篇文章既是本次tech-talk的讲义，也是我作为智能科学技术专业的学生对这几年来所学的有关图像处理、机器学习以及python编程经验的一次总结。文章略长，我希望作为一篇可以翻阅回看的知识体系文献保留，欢迎指正和扩充！

这里注意**JupyterNotebook支持python**，下文有一小节专门介绍，其余章节视同python处理。

另：文中每一小节后附有参考资料链接，都是我积累下来的，感谢这些作者的精彩讲解。

- 参考项目：[我的一个图片识别课设](https://github.com/Jyunmau/IMG-REC)

## python语言概览

除了某些课程作业老师对编程语言有特别要求外，我都坚持使用python进行图像相关的编程。这部分是我总结的有关python语言的一些基础知识，先行了解一下会在实际编码的过程中少踩坑。

python的运行环境可以简单理解为一个解释器+你调用的包（包括标准库）。如果忽略系统环境带来的一些小差异，不同的执行环境基本可以认为是不同的解释器和不同的包组成的，py**跨平台**良好，非常适合用来进行**快速开发**和**脚本编写**。

我认为在实际开发过程中**对工具的使用**只需要重点关注三个方面：语法（解释器）、环境（包）和IDE提供的功能（比如git），就像你使用相机的时候只需要重点关注光圈、快门和ISO。

### 关于解释器

python是一种解释型语言，python在2.2之后的所有官方发行版本（由PSF发行的cpython）都是GPL开源的。并不是所有的python解释器都是用“解释”的方式来执行。

#### cpython

cpython的使用相对来说最为广泛，目前来到3.9的第四个alpha版本，从官网下载安装的即是cpython。cpython拥有全网最多的教程，在遇到问题的时候可以得到很多帮助。同时cpython对于第三方包的支持也是最广的，尤其是opencv一类C写成的包。不过**cpython有一个GIL设计导致在执行的时候无法有效利用CPU的多核心**，是表面上的多线程而实际上的单线程，但通过多进程，也可以有效利用多核。

基于cpython的发行版有Anaconda，其特点在于集成包和环境管理器，在下一小节介绍。

#### non-cpython

cpython并不适用于所有开发需要，python涌现了多种第三方版本，比如为提升性能而生的PyPy（使用JIT技术）、Jython（编译生成java字节码）等。

PyPy尽管可以真正做到多线程并发，但是它**对于C编写的库存在一些不兼容**的情况（opencv有一个版本专门针对PyPy维护，但效率并没有明显提升），而且与cpython在语法上存在一些差异，在图像处理上不推荐使用。

#### 其他说明

还需要注意的是**python2.x和python3.x之间互不兼容**，两个环境之间切换要先测试。在macOS10.10之后的版本都带有python2.7，Linux的几个发行版本也如此，python3需要自行安装。Windows不带有任何版本的python。

由此而言，**python不太适合编写CPU密集型的程序**，比较适合I/O密集型程序（比如爬虫）。如果需要大量的运算（比方说各种图像算子），建议使用C程序包。

———————————————— <<<

- [菜鸟教程-py环境搭建](https://www.runoob.com/python/python-install.html)
- [菜鸟教程-py3](https://www.runoob.com/python3/python3-tutorial.html)
- [Think-Python-中文版](https://cycleuser.gitbooks.io/think-python/content/)
- [python官方文档](https://docs.python.org/zh-cn/3/)
- [廖雪峰对py进程与线程的讲解](https://www.liaoxuefeng.com/wiki/1016959663602400/1017627212385376)

### 包与环境

几乎所有入门教程都教你直接在系统命令行下使用`pip install ***`来安装第三方包，但你必须**清醒认识到环境管理的重要性**。系统命令行下执行的上述命令会把所有包都安装在一个系统环境下（下面我称之为主环境），这样的坏处有三：

1. 你所有的程序都依赖这个主环境运行，如果环境不兼容（比如在两个项目中使用不同版本的软件包或者两个项目中的软件包冲突），那你除了彻底清除python环境重装没有别的办法。
2. 当你在这个主环境下打包程序依赖时将同时打包你安装过的所有包。
3. 当你创建虚拟环境时需要基于主环境来创建（当然也可以只基于解释器，取决于环境管理工具），这样虚拟环境将毫无意义。

除非你的机器只跑一段明确固定依赖的代码，推荐的做法是：

1. 在**系统中只安装解释器**，不安装第三方包或只安装特别通用的比如NumPy。
2. 为每个项目创建一个或多个**虚拟环境**并保存在项目目录下，并创建依赖声明文件。
3. **不要让git跟踪虚拟环境文件夹**（要不你就会因为变更超多的文件以及巨大的文件体积在commit和push的时候遇上麻烦，使用依赖文件比如`pip freeze`来声明依赖环境）。
4. 使用**环境管理器**和**包管理器**来控制代码的运行环境。

包管理器是方便管理第三方包的安装、卸载及发布的，当然首推pip。`pip`或官方叫做`PyPI`也是PSF发行的，提供一个超丰富的第三方包云端库，你可以通过它方便的安装卸载第三方包。由于主站在国外，可以**更换国内的镜像源**来提高包的下载速度。**pip一般不需要特别安装**，安装cpython的时候就会顺带给你安装好。

虚拟环境管理器可以使用`virtualenv`，它提供了创建和管理虚拟环境的功能，你可以通过它切换虚拟环境执行python程序。

如果你使用PyCharm，那么IDE本身已经自带有上述两种功能的工具，而且支持图形化界面操作。如果你使用命令行或者VSC，推荐使用`Pipevn`，集两种工具于一身。

#### Anaconda

`Anaconda`是一个Python发行版（基于cpython），它集成了一个带有常用数据分析包的Python环境，并有一个专门面向数据分析和机器学习的第三方包云端库。同时，`Anaconda`还集成环境管理工具和包管理工具**conda**，支持从conda的云端库和用pip两种方式下载第三方包，**对tensorflow及其衍生软件包的安装非常友好**。Anaconda的一个好就是很多在数据分析/机器学习/数字图像分析方面的**常用库他给你自带了**，还帮你对应好了版本，很少有版本冲突的问题，而且很多研究生清一色Anaconda，**出现问题容易获得帮助**。如果你不想倒腾，最好的办法就是直接**使用带Anaconda的PyCharm版本**。

Anaconda的另一个优势在于**conda把python本身也看作包**，所以在构建虚拟环境的时候你可以轻松切换想要的py版本（比方说tf只提供到py3.6的支持，即使是3.7的包也会遇到奇奇怪怪的问题）。当然如果你有在环境中配置多个不同py版本环境的需求，可以尝试**pyenv**。其实**pipenv也已经集成有py版本切换的功能**，而且**PyCharm支持从pipenv加载虚拟环境**。

要做一个优秀的调包侠！

———————————————— <<<

- [pip官方文档](https://packaging.python.org/tutorials/installing-packages/)
- [pip清华源镜像替换方法](https://mirror.tuna.tsinghua.edu.cn/help/pypi/)
- [Pipenv官网](https://pipenv-fork.readthedocs.io/en/latest/)
- [Anaconda官网](https://www.anaconda.com/)
- [豆瓣-Anaconda教程](https://www.douban.com/group/topic/113236201/)
- [github-pyenv的repo](https://github.com/pyenv/pyenv#homebrew-on-macos)

### 关于IDE

其实好用的IDE是很主观的，他和个人开发习惯和项目需求有关。我第一次接触Python是命令行&NotePad++，后来随着开发需要慢慢转移到功能更丰富的IDE上来。另外尽管NotePad++本身是一款不错的开源IDE，但这位**NotePad++的作者是个台独**，大家一起抵制他。

#### PyCharm

PyCharm是我自己在用的IDE，jetbrains家的IDE就是一个**无脑之选**，自带集成了丰富实用的功能，又允许用户通过插件进行一定的改造，下载安装之后你只需要在interpreter里填上解释器的路径就可以开始使用了。如果你对环境配置和开发需要用到的功能并不是很熟悉，直接从PyCharm社区版开始就是一个非常好的选择，等你熟悉了之后再迁移到你更喜欢的IDE也没有什么阻碍。

几个我用的比较多的功能是：format（自带pep8的编码规范）、git（和我的GitHub绑定可以对远端repo进行操作）、interpreter（创建并管理多个虚拟环境）、全局搜索（搜文件内容和设置项）、statistics（自己安装的代码统计插件）、自动补全和纠错（包括语法提示和接口参数提示）、内置的终端，etc. 除了代码统计插件，全部是自带的功能，社区版都有。

`社区版` **免费**，只支持纯py项目。**2019.1+移除全部jupyter功能**，如果打开文件可能损坏。

`教育版` 免费，基于社区版开发，在此基础上提供教学功能，适合python初学者。

`专业版` "With HTML, JS, **Jupyter** and SQL support."，**edu邮箱注册可以免费使用一年**。

另外还提供带Anaconda的社区版或专业版，注意要下载“**with Anaconda plugin**”的安装包。

#### VS Code

微软家的开源IDE，并不是为某种语言环境专门设计，支持多种语言。特点就是非常轻：它基本上就是自带git和插件扩展功能的文本编辑器。换句话说就是这个IDE的几乎所有扩展功能（包括高亮、代码提示、format）都需要你自己动手配置。当然，开源社区加持下有丰富的插件可以选择，你可以把它打造成任何你想要的样子而不附带你用不到的东西，所有选择权都在你手上。**它之所以被称为宇宙最强IDE是因为使用者是一群大佬**，刚入门的话乖乖看上面的PyCharm。我并不是说它不好，VSC是个很棒的IDE，只是你不能下下来马上就能开工，还要配置一堆东西，如果你对要配置的都是什么并不熟悉，那就是给开发埋坑。

其他的优点还有：**免费**，以及现在**原生支持jupyter**。

———————————————— <<<

- [PyCharm下载](https://www.jetbrains.com/pycharm/download/other.html)
- [菜鸟教程-PyCharm安装指引](https://www.runoob.com/w3cnote/pycharm-windows-install.html)
- [VS Code下载](https://code.visualstudio.com/)
- [VS Code-Python插件推荐](https://zhuanlan.zhihu.com/p/44570901)

## 图像处理库

在python下图像处理库大致分为两派：C-Lib和pure-Python，除此之外诸如`matplotlib`是个大杂烩，还有一些包比如`Qt`也提供了简单的图像处理功能。调用图像处理库的时候要尤其**留意输入输出的数据结构**（比如opencv默认使用的dtype是uint8，但矩阵运算可能得到float64。彩图通道opencv是BGR，而skimage是RGB，Qt中是RGBA），接口有多个输出的时候还要注意顺序。

以下图像处理库是目前使用比较广泛的（主要是我只用过这几个🐶）：

### opencv

久负盛名的图像处理库，**包含基本的图像处理方法并持续更新cv算法，以及还带有机器学习模型**（svm、knn）。python版本只是将API封装了一下并基本与C++版本一致（这是使用Python支持的C语言桥接功能，感兴趣可以搜来看），实际上还是一个C库，最大的优势就在于**性能好**，尤其是处理大量数据和复杂算法的时候。缺点也在于它是一个C库，如果你想用python直接对里面的算法做一些修改，甚至二次开发，那就别想了。

opencv有很多的版本，还有众多软件包是基于某一个版本二次开发的，某些接口可能会随着版本更新而改变甚至删除，而且所有版本都用cv2命名空间，所以经常会碰到**版本冲突**的问题，这个时候就需要用到**多个虚拟环境**了。下面是一些pip上的opencv不同版本简介：

`opencv-python` 这是一个现在还在**持续维护**的opencv桌面版本，基本上对应官方C++版的发布。

`opencv-contrib-python` 在`opencv-python`的基础上**包含non-free算法**（比如SIFT）

需要注意的是，**non-free算法诸如SIFT在3.4.9+版本中会被移除**，最新的`contrib`也不支持。`headless`版本是不带图形界面的（比如没有 imshow），主要用在服务器上。

`pyopencv` 主页上的最后一次更新在2010年，**不推荐**。

opencv还有一大麻烦是官网访问超级慢，导致下载和访问在线文档都很麻烦，python版本又不像C++版有很多国人维护的第三方中文文档。你可以考虑用如下代码将帮助信息输出到一个文件里来访问。下面我也**给出了官网上3.4.9版本离线文档的百度云链接**，直接搜索C++的接口名称，里面会给出C++和Python的接口信息。需要注意的是，python的文档和示例都相当不完善，网上也搜不出来多少博客，所以很多时候是去看C++的文档然后接下来靠猜。

```python
import sys
import cv2

out = sys.stdout
sys.stdout = open("help_cv2.md", "w")

help(cv2)

sys.stdout.close()
sys.stdout = out
```

### skimage (scikit-image)

这是一个纯python实现的图像处理库，一些基本操作是基于Pillow实现的。如果你只需要用到基本的图像预处理操作（平滑、二值化、形态学操作之流），而不涉及复杂的图像算法可以考虑这个库。**Anaconda预安装有**。

### Pillow

这个项目是对python2.x版本的标准库PIL的持续维护，使之支持更新的python版本，功能只有很简单的图像数据处理操作，**Anaconda预安装有**。

———————————————— <<<

- [opencv-python的pip主页](https://pypi.org/project/opencv-python/)
- [opencv3.4.9离线文档-提取码：6tba](https://pan.baidu.com/s/1jzorv__H_5ljPekR_nzuIw)
- [skimage主页&文档](https://scikit-image.org)
- [Pillow的主页&文档](https://pillow.readthedocs.io/en/stable/index.html)

## 图像处理初探

图像可以看作一个矩阵，对图像的处理可以理解为对矩阵进行各种运算。当然，在实际实现的过程中为了提高性能，图像不作为矩阵来进行运算。实际运用中，如果是成熟的算法，肯定是直接调用经过百般优化的库函数性能最好，但要使用什么样的处理操作组合来达到想要的效果，还是要熟悉各算法的原理灵活应用。

如果你熟悉摄影后期，对理解不同算法产生的效果有帮助，你可以用PS辅助理解算法效果。但需要注意的是，**PS（或其他图片处理软件）并不是“所见即所得”**，比如橡皮擦/画笔会在A通道留下痕迹而肉眼看不出来，如果使用PS做数据集预处理要留心。

### 基本操作（预处理）

预处理的目标是消除图片本身对后续处理带来的影响，但任何处理之后得到的图像都会丢失元图像的数据，比方说光照不均，你肉眼所看到的过暗过曝并不代表机器也看不到这些位置的细节。

1. 消除噪点——平滑滤波
2. 消除光照不均——直方图均衡化
3. 二值化

### 特征提取

特征提取是个针对数据集高度特异性的东西，没有什么普适的特征，只有用上去有效才是好特征。

#### 统计特征

1. 圆度

   圆度就是画出图像的外切圆然后计算图像的面积和这个圆的面积比。

2. 矩

   `Mpq =∫∫(x^p)*(y^q)f(x，y)dxdy(p，q = 0，1，……∞）`

   矩在统计学中被用来反映随机变量的分布情况，推广到物理中，它被用作刻画空间物体的质量分布。同样的道理，如果我们将图像的灰度值看作是一个二维或三维的密度分布函数，那么矩方法即可用于图像分析领域并用作图像特征的提取。

#### 算子特征

算子本身是一种卷积，先通过卷积运算得出来一个图谱，然后再通过分块直方图之类的方法得到一个特征序列。当然这个图谱的意义会和原图有很大的区别，甚至不再是空间域的。

1. lbp

   计算某一像素周围的像素与该像素的差值，大于取1小于取0得到二进制编码，二进制编码转换十进制（等效编码还有跳变位数的区别）后得到该像素的一个“特征码值”，全图计算后得到一张新的图像，其像素值从原来的灰度值变为这个“特征码值”。

   将图像分为一个个小块，比如3*3划分得到9个块（cell），分别计算直方图，就可以得到最终的特征。

### 智能专业的图像处理实践作业

#### 算法课设

使用C++实现，GitHub上有公开的代码，算法来自一篇古老的paper。

- 智能剪刀算法（Intelligent Scissors）

#### 图像分析基础课实验

编程时使用C（注意不是调用opencv接口，需要练习如何实现以理解有关概念），要求进行性能优化（如使用LUT表、利用指针减少遍历时的循环层数）。具体方法和理论细节由于老师的讲义尚未公开出版，不便贴出，仅将做过的实验列出，可以自己琢磨实现。

- 均值方差规定化（图像的线形与非线性变换）
- 直方图均衡化与规定化（包括求取直方图）
- 平滑滤波（均值、中值、极值、高斯）
- 边缘检测（微分算子的运用，综合一阶的强度和二阶的位置信息）
- 图像分割-消除光照不均（otsu方法以及局部、加权、二维直方图的构建）
- 行道线检测（Hough Transform）
- 大米计数（基于链码的轮廓跟踪与填充）
- 其他优化方法（投影积分、避免除法和导数、cache访问优化等）

#### Matlab课大作业

这是对图像分割各种方法的应用。作业要求对多张彩色图像进行批量的ROI区域分割，难点在于每张图像具有不同的特点，比如纤细区域与大块区域同属于一个ROI。

- 形态学处理（膨胀、腐蚀）
- 分水岭算法
- 区域扩张和收缩
- 对RGB和HSV的多通道处理

## 用python的语法糖处理图像

做性能优化大多数时候你需要依靠巧妙的数学技巧减小算法公式中的复杂度，以便于计算机运算。Python作为一种比较高级的语言，自不能同C一样针对机器优化程序运算，但巧妙运用一些Python的语法可以很大程度上提高图像处理的效率。

1. 生成器和迭代器

   `yield`   `next`   `send`

2. 列表生成器

   `[exp for iter_var in iterable if_exp]`

## 机器学习初探

### 传统方法

### 深度的方法

### JupyterNote

### 智能专业的机器学习实践作业

## 有关机器学习的一些工具和资料

#### 比较好的一些学习资料

- [网易云课堂-吴恩达机器学习](https://study.163.com/course/courseLearn.htm?courseId=1004570029#/learn/video?lessonId=1049052745&courseId=1004570029)
- [GitHub-吴恩达深度学习](https://github.com/fengdu78/deeplearning_ai_books)

### 利用Docker打造一个炼丹炉

## 用于工程开发的python

python也是一种面向对象的编程语言，同时他也有对与函数的特殊支持。python用域的概念使得其既可以方便的进行面向对象的编程，也对面向函数及脚本尤其是测试提供了方便。

## 记录一些坑

## 更多的栗子、教程和工具链接
